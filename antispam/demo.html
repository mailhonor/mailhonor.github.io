<!DOCTYPE html>
<HTML lang="zh-CN">
<HEAD>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<LINK rel="icon" href="data:image/ico;base64,aWNv" />
<TITLE>基于统计的垃圾邮件过滤器</TITLE>
<style type="text/css">
html,body{height:101%;padding:0;margin:0;font-size:16px;font-family:arial,tahoma,SimSun,sans-serif;}
DIV.title *{color:#000000;}H1,H2{color:#CC00CC;}H3{color:#996600;}
A{text-decoration:none;color:#3399cc;}A:hover{text-decoration:underline;}
LI{margin:5px 0;}P{margin:10px 0 1px 0;}DIV.hr{border-top:1px solid black;margin:20px 0;}
.mtb{border-spacing:0;width:100%;}
.mtb td{border-bottom:1px dashed #CCC;padding:5px 2px;}
.mtb tr:hover td{border-bottom:1px dashed #999;}
PRE.code{border-left:1px solid #CCC;padding:10px;}
DIV.con{margin:20px auto;width:1000px;}DIV.main,DIV.foot{padding-bottom:50px;}
#ubt{position:relative;background:#fafafa;border:1px solid #999;border-radius:3px;overflow:hidden;height:99px;}
#ubt input{position:absolute;top:0px;height:99px;left:-999px;width:9999px;opacity:0;}
#ubt:hover{background:#eee;cursor:pointer;}
.bt:hover {cursor:pointer;}
</style>
<script src="//apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
var require_host = "http://mailhonor.com:25081";
if (window.location.href.split("https://").length>1) { require_host = "https://mailhonor.com:25441"; }
function mGetData(req, callback) {
  $.ajax({
    url:require_host+"/cgi-bin/honor_spam.do", type:"post", dataType:'json', timeout:100*1000,
    data: {req:JSON.stringify(req)},
    error:function(xhr, textStatus, thrownError) {callback({errcode:"err"});},
    complete: function (ajaxData){ var data=ajaxData.responseJSON;callback(data?data:{errcode:"err"});}
  });
}

function splitUpload(as) {
  if (!XMLHttpRequest.prototype.sendAsBinary) {
    XMLHttpRequest.prototype.sendAsBinary = function(datastr) {
      function byteValue(x) { return x.charCodeAt(0) & 0xff; }
      var ords = Array.prototype.map.call(datastr, byteValue);
      var ui8a = new Uint8Array(ords);
      this.send(ui8a.buffer);
    };
  }
  var R={},fo=as.file; R._file = as.file; R._url = (as.url?as.url:require_host+"/cgi-bin/upload.do");
  R._on_error = as.error||function(){}; R._on_progress = as.progress||function(){};
  R._on_cancel = as.cancel||function(){}; R.upload_id = as.upload_id;
  R.block_size = (as.block_size?as.block_size: 1024 * 1); R.file_data_begin = 0; R.file_data_end = -1;
  R.enable = 1; R.completed = 0; R.error = 0;
  R.file_name = fo.name; R.file_lastModified = fo.lastModified; R.file_size = fo.size; R.file_type = fo.type;

  R.do_upload = function() {
    function _do(R) {
      if(R.file_data_begin>=R.file_size){R.completed=1;R._on_progress(R);return R;}else{R._on_progress(R);}
      if (!R.enable) { R._on_cancel(R); return R;}
      R.file_data_end = R.file_data_begin + R.block_size;
      if (R.file_data_end > R.file_size){R.file_data_end = R.file_data_begin + R.file_size%R.block_size; }
      var blob = R._file.slice(R.file_data_begin, R.file_data_end);
      var reader = new FileReader();
      reader.onloadend = function() { R.ajaxSendAsBinary(this.result); };
      var e; try{reader.readAsArrayBuffer(blob);}catch(e){R._error=1;R._completed=1;R._on_error(R);}
    }
    _do(R); return R;
  }
  R.start = function() { this.do_upload(); }
  R.ajaxSendAsBinary = function(blob) {
    var xhr = new XMLHttpRequest();
    xhr.open("post", R._url, true);
    xhr.setRequestHeader("Content-Type", "application/octet-stream");
    xhr.setRequestHeader("X-Libzc-Upload-Magic", R.upload_id+","+R.file_size+","+R.file_data_begin+","+(R.file_data_end-R.file_data_begin));
    xhr.onreadystatechange = function() {
      if (this.readyState === 4) {
        if (this.status === 200) { R.file_data_begin += R.block_size; R.do_upload();
        } else { R._error=1;R._completed=1;R._on_error(R); }
      }
    };
    xhr.send(blob); return R;
  };
  return R;
}

function human_size(a){ var v=parseInt(a/(1024*1024)), s=a%(1024*1024)+"0000";return v+"."+s.substring(0,2);}

function create_tr(fo) {
  var tr=$('<tr class="itr"><td></td><td></td><td></td><td></td></tr>').get(0); $("#listtb tr:first").after(tr);
  var o=$(tr).find("td");
  tr.td_score=o.get(0);tr.td_name=o.get(1);tr.td_del=o.get(2);tr.fo=fo;
  $(tr.td_name).text(fo.name+"("+human_size(fo.size)+"M)");
  tr.upload_enable=1;
  $('<span class="bt">删除</span>').appendTo(tr.td_del).click(function(){
    if(tr.uploader){ tr.uploader.enable=0;} tr.upload_enable=0; $(tr).remove();
  });
  return tr;
}

function upload_one_by_one(trs){
  function upload_next(trs){setTimeout(function(){upload_one_by_one(trs);},10);}
  function upload_error(tr,R) { $(tr.td_score).text("失败");}
  function upload_cancel(tr) {  }

  if (trs.length==0){return;} var tr=trs.pop();
  if (tr.upload_enable==0){upload_next(trs); return;}
  if (tr.fo.size > 1024*1024*6) { $(tr.td_score).text("太大"); upload_next(trs); return;}
  if (tr.fo.size < 100) { $(tr.td_score).text("太小"); upload_next(trs); return;}

  var blob = tr.fo.slice(0, tr.fo.size>4096?4096:tr.fo.size);
  var reader = new FileReader();
  reader.onloadend = function(){ var r=this.result.toLowerCase();
    function f(k) { return (r.indexOf("\n"+k+":")>-1?1:0);}
    if(f("from")+f("to")+f("subject")+f("message-id")+f("date")<2){
      $(tr.td_score).html('<font color="red">EML信件?</font>');
      upload_next(trs); return;
    } else {
      mGetData({action:"require",filesize:""+tr.fo.size}, function(data) {
        if (data.errcode!="ok") {upload_error(tr);upload_next(trs);return;}
        tr.upload_id=data.id;
        tr.uploader = splitUpload({file:tr.fo, upload_id:tr.upload_id, block_size:1024*600,
          error: function(R) {upload_error(tr, R);upload_next(trs);},
          cancel: function(R) {upload_cancel(tr);upload_next(trs);},
          progress: function(R) {
            var v = R.file_data_begin/R.file_size;
            if (v>=1){v="100";}else{v+=".000";v=v.split(".")[1]; v=(v[0]=="0"?"":v[0])+v[1]+"."+v[2]; }
            $(tr.td_score).text(v+"%");
            if (v == "100"){
              mGetData({action:"score", id:tr.upload_id}, function(data) {
                if (data.errcode!="ok") {score_error(tr);upload_next(trs);return;}
                $(tr.td_score).text(data.score); upload_next(trs);
              });
            } else if (tr.upload_enable==0){R.enable=0;}
          }
        });
        tr.uploader.start();
      });
    }
  }
  var e; try{reader.readAsBinaryString(blob);}catch(e){ $(tr.td_score).html("错误"); upload_next(trs); return; }
}

function upload_by_files(files) {
  var fs=[],trs=[],i;if(typeof(files)=="object"){for(i=0;i<files.length;i++){fs.push(files[i]);}}else{fs=files;}
  $.each(fs.reverse(),function(){trs.push(create_tr(this));}); upload_one_by_one(trs);
}

function create_ubt() {
  var o=$('<input type="file" multiple="multiple" />');
  $("#ubt").find("input").remove(); preapre_drap(o.get(0));
  o.change(function(){upload_by_files(this.files);setTimeout(function(){create_ubt();},1);}).appendTo("#ubt");
  $("#listtb span.bt").click(function(){$("#listtb tr.itr").remove();});
}

function preapre_drap(b) {
  d = $("#ubt").get(0);
  b.ondragenter=function(e) {
    e.preventDefault();
    d.style.backgroundColor="#eee";
  }
  b.ondragover=function(e) {
    e.preventDefault();
  }
  b.ondragleave=function(e) {
    e.preventDefault();
    d.style.backgroundColor="";
  }
  b.ondrop=function(e) {
    e.preventDefault(); if(e.dataTransfer.files.length==0){return;}; 
    d.style.backgroundColor=""; upload_by_files(e.dataTransfer.files);
  }
}

function ignore_some_drap() {
  var c=document.body;
  c.ondragenter=function(e) {e.preventDefault();}
  c.ondragover=function(e) {e.preventDefault();}
  c.ondragleave=function(e) {e.preventDefault();}
  c.ondrop=function(e) {e.preventDefault(); if(e.dataTransfer.files.length){return; false;}}
}

$(window).load(function(){ create_ubt(); ignore_some_drap()});
</script>
</HEAD>
<BODY><DIV CLASS="con">
<DIV CLASS="title"><A HREF="/" TARGET="_blank">Linux平台邮件技术<small> --- 闭门造车,出门合辙</small></A></DIV>
</DIV>
</DIV><DIV CLASS="hr"></DIV><DIV CLASS="con main">

<H2>基于内容的垃圾邮件识别 --- 在线效果演示</H2>
<P>honor-spam是一款基于内容的邮件打分系统,用于识别垃圾邮件. 有免费版. <A HREF="./" target="_blank">查看文档</A>
<P><BR></P>

<DIV ID="ubt"><INPUT TYPE="file" /><DIV><TABLE><TR><TD HEIGHT="88" VALIGN="middle"><P>点击上传, 或拖拽到这里, eml格式, 小于1M, 支持批量上传</P><P><FONT COLOR="red">文件类型必须是<B>EML</B>格式, 不支持outlook的<B>MSG</B>格式, 也不支持其他类型的文件</FONT></P><P>本系统会给出一个得分.得分介于0.0~1.0之间, 大于0.7则可以认为是垃圾邮件<BR/></P></TD></TR></TABLE></DIV></DIV>
<P><BR/>

<TABLE ID="listtb" CLASS="mtb">
<TR>
<TD WIDTH="100"><NOBR>得分</NOBR></TD>
<TD>文件名(大小)</TD>
<TD WIDTH="50"><NOBR><span class="bt">删除</span></NOBR></TD>
</TR><TR>
</TR>
</TABLE>

</DIV><DIV CLASS="hr"></DIV><DIV CLASS="con foot">
<A HREF="https://gitee.com/linuxmail/" TARGET="_blank">我的项目</A> &nbsp; EMAIL: eli960@qq.com &nbsp; QQ: 1537212398 &nbsp; <A HREF="https://github.com/" TARGET="_blank">GITHUB.COM 提供技术支持</A>
</DIV></BODY>
</HTML>
