---
layout: wiki
title: HONOR-GRID异步IMAP/POP服务器
---

<p>HONOR-GRID是一个IMAP/POP服务器. 开源:
<A href="https://github.com/mailhonor/honor-grid" target="_blank">https://github.com/mailhonor/honor-grid</A>
<p>基于epool,全异步模型,高并发. 邮件存储支持去重.
<p>后台存储支持插件,目前支持mysql+file(既所有的邮件数据全部存储在mysql+文件系统上).
<p>所有webmail用的到的都已经存储在mysql中, 包括 主题,发件人,附件名,正文...,并全部转为utf-8编码.
<BR>支持邮件会话(类似gmail)

<H2>安装,初始化,认证,运行</H2>
<p>安装过程包括, 程序,mysql数据库,认证配置.
<BR>默认安装目录是 <B>/opt/honor_grid/</B>,安装目录就是程序的运行目录.

<H4>安装程序包</H4>
<p>安装包为honor_grid.tgz, 1)
<A href="/wiki/honor-grid-make.html" target="_blank">从源码编译</A>
或 2)<i>百度网盘下载,敬请期待</i>
<p>创建目录 /opt/honor_grid/ ,进入其中,解开honor_grid.tgz,即可

<H4>初始化mysql</H4>
<pre>
create database grid;
mysql -Dgrid &lt; dev/mysql/1.0.sql
</pre>
<p>mysql表格介绍,性能调优,邮件操作,见 <A href="./honor-grid-mysql.html" target="_blank">HONOR-GRID后台MYSQL</A>

<H4>认证配置</H4>
<p>只支持pam认证方式,服务名默认imap(可配置), 对应的配置文件 /etc/pam.d/imap
<p>pam是Linux平台经典的认证系统,插件很多,至少支持mysql

<H4>启动/停止/重启</H4>
<p>进入安装目录
<pre>
/opt/honor_grid/bin/honor_grid.sh start/stop/reload
</pre>

<H2>邮件帐号管理</H2>
<p>帐号管理,只需操作mysql即可. 以 q1@t.com 为例子.  <A href="./honor-grid-mysql.html">HONOR-GRID后台MYSQL</A>

<h3>添加帐号 q1@t.com</h3>
<p>方法一,调用存储过程 grid_add_user.
同时会给这个帐号添加一些预设的子邮箱,包括: INBOX, Sent, Drafts, Junk, Trash.
<pre>
begin;
call grid_add_user("q1@t.com");
commit;
</pre>

<p>方法二,实际上是上面的grid_add_user的实现.
<pre>
begin;
INSERT IGNORE INTO grid_user SET mail="q1@t.com", uidvalidity_next=UNIX_TIMESTAMP(), uidvalidity_inbox=uidvalidity_next+1;
call grid_add_folder_by_mail("q1@t.com", "INBOX");
call grid_add_folder_by_mail("q1@t.com", "Sent");
call grid_add_folder_by_mail("q1@t.com", "Drafts");
call grid_add_folder_by_mail("q1@t.com", "Junk");
call grid_add_folder_by_mail("q1@t.com", "Trash");
commit;
</pre>

<h3>删除帐号 q1@t.com</h3>
<pre>
begin;
DELETE FROM grid_user WHERE mail="q1@t.com";
commit;
</pre>

<H2>服务,程序,配置和端口</H2>
<p>对外服务包括,imapd, ssl-imapd, pop3d, ssl-pop3d, receiver, 内部服务包括, clear
<p>这些服务的配置文件在 etc/service/, 其中 etc/service/main.cf 为全局配置,其他配置为各个服务的个性化配置

<h3>全局配置文件 etc/service/main.cf</h3>
<pre>

#zrun_user, 各服务运行帐号,默认是root,如果改变运行帐号,请注意/opt/honor-grid/下文件,目录的读写权限
zrun_user = 

#日志级别, 由高到低为: error, warning, notice, info, debug, verbose
zlog_level = info

#auth_pam_service, 认证只支持pam, smtp是pam认证的服务名,对应的pam配置为 /etc/pam.d/imap
auth_pam_service = imap

#存储,邮件本身存储在文件系统,其他格式化数据存储在mysql
storage_mysql_host = 127.0.0.1
storage_mysql_user = root
storage_mysql_pass = 
storage_mysql_dbname = grid
storage_mysql_port = 3306

#storage_mysql_debug 日志, 是否输出mysql语句
storage_mysql_debug = no

#storage_mail_path, 邮件本身存储的目录
storage_mail_path = ./var/mail/

#如果需要ssl或tls则,必须给出证书路径.
ssl_cert_file = etc/ssl/grid.crt
ssl_key_file = etc/ssl/grid.key

#imapd_protocal_debug, 日志, 是否输出imapd的客户端协议
imapd_protocal_debug = yes

#imapd_search_permit_body, 是否支持全文搜索.建议关闭,影响性能
imapd_search_permit_body = no

#imapd_append_tmp_path, imap客户端邮件上传缓存路径
imapd_append_tmp_path = ./var/append/
#imapd_append_size_limit, imapd客户端上传邮件上限
imapd_append_size_limit = 100M

#imapd_uid_list_cache, imapd邮箱下,邮件id列表缓存目录
imapd_uid_list_cache = ./var/ulc/

#pop3d_protocal_debug, 日志, 是否输出pop3d的客户端协议
pop3d_protocal_debug = yes
</pre>

<h3>imapd服务 etc/service/imapd.cf</h3>
<pre>
#zlisten 监听端口,下同
#如果启用多个不同端口,在etc/service/下复制一份,修改zlisten即可,下同
zlisten = 0:143
zcmd = libexec/imapd

#zproc_limit 并发进程数,下同
zproc_limit = 2

#worker_concurrency_limit_per_process 一个进程并发线程数,最大值100,建议为10
#一个线程大约可以支持10个左右的并发连接.
#一个线程占用一个mysql连接,下同
worker_concurrency_limit_per_process = 10

#starttls_mode 是否支持tls,建议开启
starttls_mode = 1
</pre>

<h3>ssl-imapd服务 etc/service/ssl-imapd.cf</h3>
<pre>
zlisten = 0:993
zcmd = libexec/imapd
zproc_limit = 2

worker_concurrency_limit_per_process = 10

#ssl_mode 启用ssl
ssl_mode = yes
</pre>

<h3>pop3d服务 etc/service/pop3d.cf</h3>
<pre>
zlisten = 0:110
zcmd = libexec/pop3d
zproc_limit = 2

#一个线程大约可以支持10个以上的并发连接.
worker_concurrency_limit_per_process = 10

#pop3协议不支持starttls
</pre>


<h3>ssl-pop3d服务 etc/service/ssl-pop3d.cf</h3>
<pre>
zlisten = 0:995
zcmd = libexec/pop3d
zproc_limit = 2

worker_concurrency_limit_per_process = 10

#ssl_mode 启用ssl
ssl_mode = yes
</pre>

<A id="_receiver"></A>
<h3>receiver服务 etc/service/receiver.cf</h3>
<p>本地程序向honor-grid存储信件服务,对应的客户端程序是 bin/deliver
<pre>
zlisten = socket/receiver
zcmd = libexec/receiver
zproc_limit = 1
worker_concurrency_limit_per_process = 10
</pre>

<p>通信协议非常简单,可以实现自己的客户端 <A href="#_receiver_protocal">receiver通信协议</A>

<h3>clear服务 etc/service/clear.cf</h3>
<p>用于清理过期的mysql数据,邮件,和临时文件,不必关注
<pre>
zlisten = socket/clear
zcmd = libexec/clear
zproc_limit = 1
zwakeup = 100
</pre>

<A id="_deliver"></A>
<h3>deliver程序 bin/deliver</h3>
<p>bin/deliver是信件投递(给imapd)程序,是 <A href="#_receiver">libexec/receiver</A>的客户端
<p>参数如下
<pre>
[xxx@zytest]$ /opt/honor_grid/bin/deliver -h

/opt/honor_grid/bin/deliver
      -to address                  #
      -eml email_filename          #
    [ -mbox mailbox_of_address ]   # default INBOX
    [ -addr socket_of_receiver ]   # default /opt/honor_grid/socket/receiver
    [ -answered-flag ]             # set answered-flag 
    [ -seen-flag ]                 # set seen-flag 
    [ -draft-flag ]                # set draft-flag 
    [ -flagged-flag ]              # set flagged-flag 
    [ -timeout second]             # timeout 
    [ -d ]                         # debug msg 
    [ -h ]                         # print this help 
</pre>

<p>例子
<pre>
./deliver -to abc@xxx.com -eml /opt/somepath/to.eml
./deliver -to abc@xxx.com -eml /opt/somepath/to.eml -mbox Sent
./deliver -to abc@xxx.com -eml /opt/somepath/to.eml -mbox Junk -seen-flag
./deliver -to abc@xxx.com -eml /opt/somepath/to.eml -flagged-flag -seen-flag 
./deliver -to abc@xxx.com -eml /opt/somepath/to.eml -flagged-flag -seen-flag  -mbox someMbox
./deliver -to abc@xxx.com -eml /opt/somepath/to.eml -s /opt/honor_grid/socket/receiver
</pre>
<p><B><i>请注意:/opt/somepath/to.eml必须对receiver程序可读,可见</i></B>
<p>执行结果为 <B>OK...</B> 或 <B>ERR...</B>,当且仅当输出的前两个字符为<B>OK</B>才投递成功


<h2>其他问题</h2>

<h3>安装目录</h3>
<p>默认为/opt/honor_grid/, 可以随便修改.
<br>比如改为/home/gird/,则只需要修改脚本bin/honor_grid.sh.
<br>把行
<pre>work_path="<B>/opt/honor_grid/</B>"</pre>
 改为
<pre>work_path="<B>/home/grid/</B>"</pre>

<h3>运行环境,权限,目录</h3>
<p>程序的工作目录就是安装目录.
<p>权限默认为root,可以通过配置 zrun_user 修改.要注意目录的读写权.
<p>./var/mail/为邮件默认存储目录,通过配置 storage_mail_path 修改.
./var/mail/目录下必须存在子目录
<ul>
    <li>./tmp/</li>
    <li> ./0001, ./0002, ..., ./5555, ./9998, ./9999</li>
</ul>
这些目录必须存在, 可读写执行.
<p>./var/append为imapd协议邮件上传默认临时目录,通过配置 imapd_append_tmp_path 修改.
<br>此目录必须存在, 可读写执行.
<p>./var/ulc/为imapd用, 通过配置 imapd_uid_list_cache 修改.
<br>此目录必须存在, 可读写执行.如果内存够大,把此目录放到内存盘上,可极大优化性能.

<h3>日志 syslog</h3>
<p>日志用的是syslog系统, facility是MAIL

<h3>lmtp协议和receiver协议</h3>
<p>lmtp一般用于向本地系统存储信件.lmtp协议开销大,所以本系统不予支持.
<p>而开发了receiver服务,作为信件存储方案.
<ul>
<li>简单点,可以通过<A href="#_deliver">deliver命令</A>存信.</li>
<li>高效的话,可以参考下面的通信协议自己实现.</li>
</ul>
<A id="_receiver_protocal"></A>
<p>receiver 通信协议非常简单.
<p>1,客户端 连接本地domain socket，/opt/honor_grid/socket/receiver
<BR>2,客户端发送指令
<pre>
APPEND eamil_address mbox_name absolute_email_file_path flags\r\n
</pre>
<p>flags是ASDF这4个字母的任意组和,如FS,AD,SF,ADF,etc,意思是
<BR>A:Answered, S:Seen, D:Draft, F:Flagged
<p>例子
<pre>
APPEND q1@t.com Junk /opt/tmp/to_save_tmp/abc.eml SFA\r\n
</pre>
<p>或
<pre>
APPEND q1@t.com INBOX /opt/tmp/to_save_tmp/abcdef.eml\r\n
</pre>
<p>3,返回数据格式
<pre>
关键字 其他信息\r\n
</pre>
<p>关键为 OK, ERR

<p>4, 回到第2步,或断开连接

<h3>过滤器</h3>
<p>各种sieve协议的过滤器,都有各种问题,速度慢,匹配规则复杂,中文支持不友好,可定制性基本无.
<br>比如,增加一个邮件地址黑名单就得更改一次过滤器,麻烦啊.
<p>邮件系统商基本都有更高级,更灵活的解决方案.


<H2>相关文章</H2>
<ul>
    <li><A href="./honor-grid-make.html">HONOR-GRID从源码编译</A></li>
    <li><A href="./honor-grid-mysql.html">HONOR-GRID后台MYSQL</A></li>
</ul>
