---
layout: wiki
title: HONOR-MILTER 反垃圾邮件网关
---

<p>honor-milter 是一款基于libmilter的邮件过滤系统. 兼容 postfix,sendmail
<p>支持<B>中文反垃圾</B>,spf,ip黑名单/发送频率,mail黑名单/发送频率,和 clamav查毒引擎.
<p>内嵌<B>邮件内容反垃圾识别系统</B>,
支持中文简体,繁体,日文,韩文,越南文,等文字.
<br>信件解析快速,精确,兼容度高.强大的中文字符集识别模块.独特的分词系统.高效的反垃圾库系统.
<br>速度快,在基于dell vostro 2420(notebook)的vmware虚拟机上,单线程每秒处理1000封信件.

<p>百度网盘下载 <B>免费版</B> 程序和反垃圾库:
<A href="http://pan.baidu.com/s/1hrfROqw" target="_blank">http://pan.baidu.com/s/1hrfROqw</A>

<H2>快速安装/使用</H2>
<H3>安装运行程序<small><i> &nbsp;(只支持64位Linux系统)</i></small></H3>
<ul>
    <li>创建目录 <B> /opt/honor_milter/ </B>,进入其中</li>
    <li>解开honor_milter.tgz 即可</li>
</ul>

<H3>下载/更新最新反垃圾库</H3>
<ul>
    <li>下载最新版 const-(version).db.gz,建议备份</li>
    <li>解开得到 const.db,移动到 ./spamdb/const.db</li>
</ul>

<H3>启动/停止/重启</H3>
<pre>
./bin/honor_milter.sh start/stop/reload/restart
</pre>

<H3>适配 postfix</H3>
<p>修改配置文件/etc/postfix/master.cf,在准备启用libmilter的smtpd服务下增加
<pre>
 -o smtpd_milters=inet:127.0.0.1:36130
 -o milter_protocol=6
</pre>

<H3>适配sendmail</H3>
<p>修改配置文件sendmail.mc,增加配置行
<pre>
INPUT_MAIL_FILTER(`honor_milter',`S=inet:36130@127.0.0.1')
</pre>


<H3>投递到垃圾邮件箱</H3>
<p>1) 启用内容反垃圾后,会在邮件头上追加
<pre>
X-honor-antispam: 0.893871 bad spam 或
X-honor-antispam: 0.281281 good
</pre>
<p>本系统只追加邮件头. 使用者可以根据上述信息采取过滤措施.
<p>2) 如,在imap服务器的sieve配置中加入策略,把垃圾邮件移动到垃圾邮件箱或删除等操作.
<br>以dovecot为例子,在dovecot的sieve的配置中增加
<pre>
if anyof (header :contains "X-honor-antispam" "spam")
{
    fileinto "junk";
    stop;
}
</pre>

<H2>功能模块及配置</H2>
<p>./etc/service/目录下的文件,是各个模块的配置文件.
<br>每个模块先加载./etc/main.cf,再加载自己的配置文件.


<H3>主服务milter</H3>
<p>milter,通过libmilter协议,为postfix/sendmail提供服务.
milter服务的配置文件为 ./etc/service/milter.cf
<pre>
zcmd = libexec/milter
#milter服务端口
zlisten = 127.0.0.1:36130
zproc_limit = 10
</pre>

<p>配置项包括下面介绍的各模块的配置

<h3>中文反垃圾</h3>
<p>反垃圾服务的配置文件为 ./etc/service/spamd.cf
<pre>
zcmd = libexec/spamd 

#反垃圾服务监听地址.这里请注意,反垃圾服务必须和milter服务在同一台电脑上.
zlisten = 127.0.0.1:36160

zproc_limit = 1

</pre>

<p>相关配置项
<pre>
#是否启用反垃圾功能,默认启用
antispam_enable = 1

#反垃圾服务监听地址.这里请注意,反垃圾服务必须和milter服务在同一台电脑上.
antispam_server = 127.0.0.1:36160

#反垃圾的结论,会追加到邮件头上,其邮件头的name部分
antispam_append_header = X-honor-antispam

# 工作线程数
antispam_concurrency_limit = 8

# 只读反垃圾库
antispam_constdb = spamdb/const.db

# 可写反垃圾库(用于训练,反馈）,值为空,则忽略(即不可训练,反馈)
antispam_traindb = spamdb/train.db

#阈值,参考值,反垃圾得分大于等于antispam_threshold则给出关键字 <B>bad spam</B>,否则给出关键字 <B>good</B>
antispam_threshold = 0.7
</pre>

<h3>SPF检查</h3>
<pre>
#是否启用spf检查功能,默认禁用
spf_enable = 0

#spf策略,可选header,reject,discard
#   header 把结果追加到邮件头,其邮件头的name部分由配置项spf_append_header设置
#   reject spf不一致,拒收(通知发信者)
#          在smtp协议上返回给发信者的信息由配置项spf_reject_reply设置
#   discard spf不一致,丢弃(不通知发信者)
spf_destination = header

#spf白名单,符合白名单则不做过滤
#查询表, 查询键形如 somedomain.com&amp;192.168.1.1, 或somedomain.com&amp;192.168.1
spf_whitelist =

#建议保留
spf_softfail_as_reject = 1

#如果发信域没有配置spf,则当作spf不一致,默认否.
spf_none_as_reject = 0

spf_append_header = X-honor-spf
spf_reject_reply = DENY. SPF
</pre>

<h3>CLAMAV 查毒 </h3>
<p>如果邮件系统的流量较大建议关闭此功能.
<pre>
#是否启用clamav查毒功能,默认禁用
clamav_enable = 0

#查毒策略,可选 reject,discard
#   reject 有毒,拒收(通知发信者).
#          在smtp协议上返回给发信者的信息由配置项clamav_reject_reply设置
#   discard 有毒,丢弃(不通知发信者)
clamav_destination = reject

#clamav的服务clamd监听地址
#参见/etc/clamav/clamd.conf中配置项LocalSocket和TCPSocket
clamav_server = /var/run/clamav/clamd.ctl

clamav_reject_reply = DENY. FOUND VIRUS
</pre>
<p>请注意: 如果查毒结果为 <B>Can't open file or directory</B>,出现错误的原因很多.
<br>其中一个是 apparmor 系统造成的. 请停止 apparmor,或修改 /etc/apparmor.d/usr.sbin.clamd

<h3>IP投递频率限制</h3>

<p>IP投递频率所谓的上限值形如 123-5677-123123
<ul>
<li>123,某ip,每分钟投递限制,值为0则表示黑名单</li>
<li>5677,某ip,每小时投递限制</li>
<li>123123,某ip,每天投递限制</li>
</ul>
<br>
<pre>
#是否启用ip频率限制功能,默认禁用
limit_ip_enable = 0

#投递超过频率限制,可选 reject,discard
#   reject 超过频率限制,拒收(通知发信者).
#          在smtp协议上返回给发信者的信息由配置项limit_ip_reject_reply设置
#   discard 超过频率限制,丢弃(不通知发信者)
limit_ip_destination = reject

limit_ip_reject_reply = DENY. TOO MANY

#发信频率限制的默认值
limit_ip_limit_default = 3-10-30

#查询表,结果是ip频率限制值,查询键是ip地址 <A href="#map_config">查询表配置</A>
limit_ip_limit_map = 

#查询表,结果是ip频率限制值,查询键是ip地址前三段, 形如192.168.1
limit_ip_limit_map2 = 

#实时ip频率统计服务的监听端口
limit_ip_anvil_server = 127.0.0.1:36133
</pre>

<p>查询顺序, 举例 202.106.112.58:
<ol>
    <li>在 查询表 limit_ip_limit_map 中查询,键值为202.106.112.58, 返回结果既为限制值,如无结果,则:</li>
    <li>在 查询表 limit_ip_limit_map2 中查询,键值为202.106.112, 返回结果既为限制值,如无结果,则:</li>
    <li>取limit_ip_limit_default的值为结果</li>
</ol>

<h3>SENDER投递频率限制</h3>
<p>SENDER投递频率所谓的上限值形如 123-5677-123123
<ul>
<li>123,某sender,每分钟投递限制,值为0则表示黑名单</li>
<li>5677,某sender,每小时投递限制</li>
<li>123123,某sender,每天投递限制</li>
</ul>
<br>
<pre>
#是否启用sender频率限制功能,默认禁用
limit_sender_enable = 0

#limit_sender_destination 超过频率的限制策略,可选 reject,discard
#   reject 超过频率限制,拒收(通知发信者)
#          在smtp协议上返回给发信者的信息由配置项limit_sender_reject_reply设置
#   discard 超过频率限制,丢弃(不通知发信者)
limit_sender_destination = reject

limit_sender_reject_reply = DENY. TOO MANY

#发信频率限制的默认值
limit_sender_limit_default = 3-10-30

#查询表,结果是sender频率限制值,查询键是sender地址, 形如 tom@cat.org
limit_sender_limit_map = 

#查询表,结果是sender频率限制值,查询键是sender地址的域名部分, cat.org
limit_sender_limit_map2 = 

#实时sender频率统计服务的监听端口
limit_sender_anvil_server = 127.0.0.1:36133
</pre>

<p>查询顺序, 举例 tom@cat.org
<ol>
    <li>在 查询表 limit_sender_limit_map 中查询,键值为tom@cat.org, 返回结果既为限制值,如无结果,则:</li>
    <li>在 查询表 limit_sender_limit_map2 中查询,键值为cat.org, 返回结果既为限制值,如无结果,则:</li>
    <li>取limit_sender_limit_default的值为结果</li>
</ol>

<H3>实时频率统计服务</H3>
<p>为IP/SENDER投递频率限制提供统计服务, 配置文件 ./etc/service/anvil.c
<pre>
zcmd = libexec/anvil

#如果多台电脑运行ip/sender频率限制服务,则只需(必须)在某一台服务器启用本服务.
zlisten = 0:32506

zproc_limit = 1
</pre>


<H2>附录</H2>

<H3>单独使用"内容过滤系统"</H3>
<p>内容过滤服务器,程序./libexec/spamd, 配置文件./etc/service/spamd.cf, 默认服务端口是 127.0.0.1:36160
<p>关于,邮件的回馈(训练,学习),得分,管理工具的使用等问题,请参考
 <A href="./honor-spam.html">HONOR-SPAM 荣耀邮件内容过滤系统</A>

<H3>文件目录说明</H3>
<table class="listtb">
<tr>
    <td width="300"><B>/opt/honor_milter/</B></td>
    <td>系统默认安装路径,所有服务运行时路径.</td>
</tr>
<tr>
    <td><B>./queue/</B></td>
    <td>libmilter,获得的邮件原文,临时存放地址</td>
</tr>
<tr>
    <td><B>./etc/service/main.cf</B></td>
    <td>邮件网关全局配置文件</td>
</tr>
<tr>
    <td><B>./etc/service/milter.cf</B></td>
    <td>邮件网关主程序的配置文件</td>
</tr>
<tr>
    <td><B>./etc/service/spamd.cf</B></td>
    <td>反垃圾程序的配置文件</td>
</tr>
<tr>
    <td><B>./etc/service/anvil.cf</B></td>
    <td>信件发送频率统计的配置文件</td>
</tr>
<tr>
    <td><B>./etc/service/clear.cf</B></td>
    <td>内部队列清理配置文件</td>
</tr>
<tr>
    <td><B>./bin/honor_milter.sh</B></td>
    <td>启动/停止/重启 脚本</td>
</tr>
<tr>
    <td><B>./bin/spamc</B></td>
    <td>一个工具,离线回馈,得分,测试,合并. <A href="./honor-spam.html#spamc">详细</A></td>
</tr>
<tr>
    <td><B>./bin/spamdc</B></td>
    <td>一个工具,在线回馈,得分,测试. <A href="./honor-spam.html#spamdc">详细</A></td>
</tr>
<tr>
    <td><B>./bin/spf_test</B></td>
    <td>简易spf检查工具,<A href="#spf_test">参考</A></td>
</tr>
<tr>
    <td><B>./bin/map_search</B></td>
    <td>map查询表命令行工具</td>
</tr>
<tr>
    <td><B>./libexec/master</B></td>
    <td>服务管理程序</td>
</tr>
<tr>
    <td><B>./libexec/milter</B></td>
    <td>邮件网关主程序</td>
</tr>
<tr>
    <td><B>./libexec/spamd</B></td>
    <td>反垃圾主程序</td>
</tr>
<tr>
    <td><B>./libexec/anvil</B></td>
    <td>信件发送频率统计</td>
</tr>
<tr>
    <td><B>./libexec/clear</B></td>
    <td>内部过期队列文件清理</td>
</tr>
<tr>
    <td><B>./spamdb/const.db</B></td>
    <td>反垃圾库,只读,高速.</td>
</tr>
<tr>
    <td><B>./spamdb/train.db</B></td>
    <td>反垃圾库,用于训练(回馈,喂养).速度较慢,实际上是sqlite3.</td>
</tr>
</table>

<H3 id="spf_test">spf检测工具</H3>
<p>./bin/spf_test 用于检查一个域名和一个ip是否匹配spf,用法:
<pre>
./bin/spf_test domain ip
</pre>
<p>例子
<pre>
./bin/spf_test 263.net 211.157.147.5
./bin/spf_test 163.com  202.130.113.39
</pre>

<H3 id="map_config">查询表</H3>

<p> 支持查询表,效果类似postfix的查询表机制. 支持类型包括 memcache,redis,socket,postproxy,flat,line,static

<H4>memcache</H4>
<p> 配置语法为:
<pre>
memcache://192.168.0.1:11211?prefix=前缀&amp;suffix=后缀
</pre>
<p>如查询年关键字为<B>eevp</B>, 则memcache的键值为 <B>前缀eevp后缀</B>, 命令行为:
<pre>
get <B>前缀eevp后缀</B>
</pre>

<H4>redis</H4>
<p> 配置语法为:
<pre>
redis://192.168.1.99:8008?key=键值
</pre>
<p>如查询年关键字为<B>eevp</B>, 则相当于redis的hash命令中的hget, 命令行为:
<pre>
hget <B>键值 前缀eevp后缀</B>
</pre>

<H4>socket</H4>
<p> 配置语法为:
<pre>
socket://192.168.1.99:8008?module=模块
</pre>
<p>如查询年关键字为<B>eevp</B>, 则相当于socket通信:
<pre>
<B>模块 eevp\r\n</B>
</pre>
<p>返回值为:
<pre>
#有查询结果
200 查询 ... ... 结果\r\n
</pre>
<p>或
<pre>
#没有查询结果
500\r\n
</pre>
<p>或
<pre>
#出错
400 错误 ... ... 信息\r\n
</pre>

<H4>flat</H4>
<p> 配置语法为:
<pre>
flat:///somepath/some.../someflat.txt
</pre>
<p>someflat.txt是一个text文件,内容形如
<pre>
abc abc_value
键名 键值
城市 北京
爱好 linux   等等
</pre>
<p>即, 第一列为查询值,其余为结果.
<p>flat查询表速度快.后台会把someflat.txt加载到内存,生成一个词典.如果修改了someflat.txt则需要重新加载.

<H4>line</H4>
<p> 配置语法为:
<pre>
line://192.168.1.99:8008
</pre>
<p>如查询年关键字为<B>eevp</B>, 则相当于socket通信:
<pre>
<B>eevp\r\n</B>
</pre>
<p>返回值为:
<pre>
#查询结果
查询 ... ... 结果\r\n
</pre>

<H4>static</H4>
<p> 配置语法为:
<pre>
static://返回值
</pre>
<p>查询任何关键字,返回结果都是固定的: "返回值"

<H4>postproxy</H4>
<p>postproxy支持postfix的查询表类型,类似postfix的proxy方式
<p> 配置语法为:
<pre>
postproxy:/var/spool/postfix/private/postmap:postfix查询表
</pre>
<p>postfix有查询表
<pre>
proxy:mysql:/etc/postfix/some_mysql_table.cf
</pre>
<p>则可配置为:
<pre>
postproxy:///var/spool/postfix/private/postmap?dictname=mysql:/etc/postfix/some_mysql_table.cf
</pre>

<p>当然也可以这么用(小技巧),在postfix的master.cf中配置,增加
<pre>
192.168.1.99:20028  inet  -       -       n       -       -       proxymap
 -oproxy_read_maps=mysql:/etc/postfix/some_mysql_table.cf,...,,,,
</pre>
<p>则,我们可以这么利用postfix查询表

<pre>
postproxy://192.168.1.99:20028?dictname=mysql:/etc/postfix/some_mysql_table.cf
</pre>

<H3>map_search测试工具</H3>
<p>map_search是一个map查询表测试工具,用法
<pre>
./map_search -m "查询表1,查询表2,..." -q 查询值
</pre>
<p>例子,查询<B>eevp</B> :
<pre>
./map_search -m "memcache://127.0.0.1:11211" -q eevp
</pre>
<H2>相关文章</H2>
<ul>
    <li><A href="./honor-spam.html">HONOR-SPAM 荣耀邮件内容过滤系统</A></li>
    <li><A href="./antispam-bayes.html">贝叶斯(Bayes)算法模型</A></li>
</ul>
